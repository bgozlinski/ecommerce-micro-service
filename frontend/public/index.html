<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameKeys Store</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f0f23; color: #e0e0e0; min-height: 100vh; }
        
        /* NAV */
        nav { background: #1a1a3e; padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #7c3aed; }
        nav .brand { font-size: 1.4rem; font-weight: bold; color: #a78bfa; cursor: pointer; }
        nav .nav-right { display: flex; gap: 16px; align-items: center; }
        nav .nav-right span { color: #9ca3af; font-size: 0.9rem; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.2s; }
        .btn-primary { background: #7c3aed; color: white; }
        .btn-primary:hover { background: #6d28d9; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-success { background: #16a34a; color: white; }
        .btn-success:hover { background: #15803d; }
        .btn-secondary { background: #374151; color: #e0e0e0; }
        .btn-secondary:hover { background: #4b5563; }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* MAIN */
        .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
        .hidden { display: none !important; }

        /* AUTH FORMS */
        .auth-container { max-width: 400px; margin: 60px auto; background: #1a1a3e; padding: 32px; border-radius: 12px; border: 1px solid #374151; }
        .auth-container h2 { margin-bottom: 20px; color: #a78bfa; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 0.9rem; color: #9ca3af; }
        .form-group input { width: 100%; padding: 10px 12px; border: 1px solid #374151; border-radius: 6px; background: #0f0f23; color: #e0e0e0; font-size: 1rem; }
        .form-group input:focus { outline: none; border-color: #7c3aed; }
        .auth-toggle { margin-top: 16px; text-align: center; color: #9ca3af; font-size: 0.9rem; }
        .auth-toggle a { color: #a78bfa; cursor: pointer; text-decoration: underline; }
        .error-msg { color: #f87171; font-size: 0.85rem; margin-top: 8px; }
        .success-msg { color: #4ade80; font-size: 0.85rem; margin-top: 8px; }

        /* PRODUCTS */
        .section-title { font-size: 1.5rem; margin-bottom: 20px; color: #a78bfa; }
        .filters { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filters input, .filters select { padding: 8px 12px; border: 1px solid #374151; border-radius: 6px; background: #1a1a3e; color: #e0e0e0; font-size: 0.9rem; }
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .product-card { background: #1a1a3e; border: 1px solid #374151; border-radius: 10px; padding: 20px; transition: border-color 0.2s; }
        .product-card:hover { border-color: #7c3aed; }
        .product-card h3 { color: #e0e0e0; margin-bottom: 8px; }
        .product-card .platform { color: #9ca3af; font-size: 0.85rem; margin-bottom: 4px; }
        .product-card .category { color: #6b7280; font-size: 0.8rem; margin-bottom: 12px; }
        .product-card .price { font-size: 1.3rem; font-weight: bold; color: #4ade80; margin-bottom: 12px; }
        .product-card .add-cart { width: 100%; }
        .qty-control { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .qty-control button { width: 28px; height: 28px; border: 1px solid #374151; background: #0f0f23; color: #e0e0e0; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        .qty-control span { min-width: 20px; text-align: center; }

        /* CART */
        .cart-badge { background: #dc2626; color: white; border-radius: 50%; padding: 2px 7px; font-size: 0.75rem; margin-left: 4px; }
        .cart-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .cart-table th, .cart-table td { padding: 12px; text-align: left; border-bottom: 1px solid #374151; }
        .cart-table th { color: #9ca3af; font-size: 0.85rem; text-transform: uppercase; }
        .cart-summary { text-align: right; font-size: 1.2rem; margin-bottom: 20px; }
        .cart-summary strong { color: #4ade80; }

        /* ORDERS */
        .order-card { background: #1a1a3e; border: 1px solid #374151; border-radius: 10px; padding: 20px; margin-bottom: 16px; }
        .order-card .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .order-card .order-id { font-weight: bold; color: #a78bfa; }
        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
        .status-awaiting_payment { background: #fbbf24; color: #1a1a3e; }
        .status-paid { background: #4ade80; color: #1a1a3e; }
        .status-failed { background: #f87171; color: #1a1a3e; }
        .status-cancelled { background: #6b7280; color: white; }
        .order-items { margin-top: 10px; }
        .order-items table { width: 100%; border-collapse: collapse; }
        .order-items td { padding: 6px 8px; border-bottom: 1px solid #252545; font-size: 0.9rem; }
        .keys-list { margin-top: 10px; background: #0f0f23; padding: 12px; border-radius: 6px; }
        .keys-list code { color: #4ade80; font-size: 0.9rem; display: block; margin: 4px 0; }

        /* REPORTING DASHBOARD */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #1a1a3e; border: 1px solid #374151; border-radius: 10px; padding: 20px; text-align: center; }
        .stat-card .label { color: #9ca3af; font-size: 0.85rem; margin-bottom: 8px; }
        .stat-card .value { font-size: 1.5rem; font-weight: bold; color: #a78bfa; }
        .stat-card .value.revenue { color: #4ade80; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #1a1a3e; border-radius: 10px; overflow: hidden; }
        .report-table th, .report-table td { padding: 12px; text-align: left; border-bottom: 1px solid #374151; }
        .report-table th { background: #252545; color: #a78bfa; font-size: 0.85rem; text-transform: uppercase; }
        .export-btns { display: flex; gap: 10px; margin-bottom: 20px; }

        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #1a1a3e; padding: 32px; border-radius: 12px; border: 1px solid #7c3aed; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-content h3 { margin-bottom: 20px; color: #a78bfa; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        /* TABS */
        .tabs { display: flex; gap: 0; margin-bottom: 24px; border-bottom: 2px solid #374151; }
        .tab { padding: 10px 20px; cursor: pointer; color: #9ca3af; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
        .tab:hover { color: #e0e0e0; }
        .tab.active { color: #a78bfa; border-bottom-color: #7c3aed; }

        /* LOADING */
        .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid #374151; border-top-color: #7c3aed; border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-overlay { text-align: center; padding: 40px; color: #9ca3af; }
    </style>
</head>
<body>

<!-- NAV -->
<nav>
    <div class="brand" onclick="showProducts()">üéÆ GameKeys Store</div>
    <div class="nav-right">
        <span id="nav-user" class="hidden"></span>
        <button id="nav-cart-btn" class="btn btn-secondary hidden" onclick="showCart()">üõí Koszyk <span id="cart-badge" class="cart-badge hidden">0</span></button>
        <button id="nav-orders-btn" class="btn btn-secondary hidden" onclick="showOrders()">üì¶ Zam√≥wienia</button>
        <button id="nav-admin-btn" class="btn btn-secondary hidden" onclick="showAdmin()">üìä Raporty</button>
        <button id="nav-login-btn" class="btn btn-primary" onclick="showLogin()">Zaloguj siƒô</button>
        <button id="nav-logout-btn" class="btn btn-danger hidden" onclick="logout()">Wyloguj</button>
    </div>
</nav>

<!-- AUTH: LOGIN -->
<div id="page-login" class="auth-container hidden">
    <h2>Logowanie</h2>
    <div class="form-group">
        <label>Email</label>
        <input type="email" id="login-email" placeholder="email@example.com">
    </div>
    <div class="form-group">
        <label>Has≈Ço</label>
        <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <div id="login-error" class="error-msg hidden"></div>
    <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="doLogin()">Zaloguj</button>
    <div class="auth-toggle">Nie masz konta? <a onclick="showRegister()">Zarejestruj siƒô</a></div>
</div>

<!-- AUTH: REGISTER -->
<div id="page-register" class="auth-container hidden">
    <h2>Rejestracja</h2>
    <div class="form-group">
        <label>Email</label>
        <input type="email" id="reg-email" placeholder="email@example.com">
    </div>
    <div class="form-group">
        <label>Has≈Ço</label>
        <input type="password" id="reg-password" placeholder="Min. 8 znak√≥w">
    </div>
    <div id="reg-error" class="error-msg hidden"></div>
    <div id="reg-success" class="success-msg hidden"></div>
    <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="doRegister()">Zarejestruj</button>
    <div class="auth-toggle">Masz ju≈º konto? <a onclick="showLogin()">Zaloguj siƒô</a></div>
</div>

<!-- PRODUCTS -->
<div id="page-products" class="container">
    <h2 class="section-title">üéÆ Katalog gier</h2>
    <div class="filters">
        <input type="text" id="filter-search" placeholder="Szukaj..." oninput="loadProducts()">
        <select id="filter-platform" onchange="loadProducts()">
            <option value="">Wszystkie platformy</option>
            <option value="Steam">Steam</option>
            <option value="Origin">Origin</option>
            <option value="Epic">Epic</option>
            <option value="GOG">GOG</option>
            <option value="Uplay">Uplay</option>
        </select>
        <select id="filter-sort" onchange="loadProducts()">
            <option value="created_at:desc">Najnowsze</option>
            <option value="price_cents:asc">Cena: rosnƒÖco</option>
            <option value="price_cents:desc">Cena: malejƒÖco</option>
            <option value="name:asc">Nazwa: A-Z</option>
        </select>
    </div>
    <div id="products-grid" class="products-grid"></div>
    <div id="products-loading" class="loading-overlay hidden"><div class="spinner"></div> ≈Åadowanie...</div>
</div>

<!-- CART -->
<div id="page-cart" class="container hidden">
    <h2 class="section-title">üõí Koszyk</h2>
    <div id="cart-empty" class="loading-overlay hidden">Koszyk jest pusty</div>
    <table id="cart-table" class="cart-table hidden">
        <thead><tr><th>Produkt</th><th>Ilo≈õƒá</th><th>Cena</th><th></th></tr></thead>
        <tbody id="cart-body"></tbody>
    </table>
    <div id="cart-summary" class="cart-summary hidden">
        Suma: <strong id="cart-total">0.00 PLN</strong>
    </div>
    <div id="cart-actions" class="hidden" style="text-align:right">
        <button class="btn btn-success" onclick="doCheckout()">Z≈Ç√≥≈º zam√≥wienie</button>
    </div>
    <div id="cart-loading" class="loading-overlay hidden"><div class="spinner"></div></div>
</div>

<!-- ORDERS -->
<div id="page-orders" class="container hidden">
    <h2 class="section-title">üì¶ Moje zam√≥wienia</h2>
    <div id="orders-list"></div>
    <div id="orders-loading" class="loading-overlay hidden"><div class="spinner"></div> ≈Åadowanie...</div>
    <div id="orders-empty" class="loading-overlay hidden">Brak zam√≥wie≈Ñ</div>
</div>

<!-- ADMIN DASHBOARD -->
<div id="page-admin" class="container hidden">
    <h2 class="section-title">üìä Panel Administratora - Raporty</h2>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="label">Suma zam√≥wie≈Ñ (Dzi≈õ)</div>
            <div id="stat-orders" class="value">0</div>
        </div>
        <div id="stat-paid-orders-card" class="stat-card">
            <div class="label">Op≈Çacone zam√≥wienia (Dzi≈õ)</div>
            <div id="stat-paid-orders" class="value">0</div>
        </div>
        <div class="stat-card">
            <div class="label">Przych√≥d (Dzi≈õ)</div>
            <div id="stat-revenue" class="value revenue">0.00 PLN</div>
        </div>
    </div>

    <div class="export-btns">
        <button class="btn btn-secondary btn-sm" onclick="exportReports('csv')">Eksportuj CSV</button>
        <button class="btn btn-secondary btn-sm" onclick="exportReports('json')">Eksportuj JSON</button>
    </div>

    <h3 style="margin-bottom:15px; color:#a78bfa">Top Produkty</h3>
    <table class="report-table">
        <thead>
            <tr>
                <th>Produkt ID</th>
                <th>Sprzedano sztuk</th>
                <th>Przych√≥d</th>
            </tr>
        </thead>
        <tbody id="top-products-body"></tbody>
    </table>

    <h3 style="margin-top:30px; margin-bottom:15px; color:#a78bfa">Ostatnie raporty dzienne</h3>
    <table class="report-table">
        <thead>
            <tr>
                <th>Data</th>
                <th>Zam√≥wienia</th>
                <th>Op≈Çacone</th>
                <th>Anulowane</th>
                <th>Przych√≥d</th>
            </tr>
        </thead>
        <tbody id="daily-reports-body"></tbody>
    </table>

    <div style="margin-top:40px; display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
        <h3 style="color:#a78bfa">ZarzƒÖdzanie produktami</h3>
        <button class="btn btn-success" onclick="openProductModal()">+ Dodaj produkt</button>
    </div>
    <table class="report-table">
        <thead>
            <tr>
                <th>Nazwa</th>
                <th>Platforma</th>
                <th>Cena</th>
                <th>Stock (Dostƒôpne)</th>
                <th>Status</th>
                <th>Akcje</th>
            </tr>
        </thead>
        <tbody id="admin-products-body"></tbody>
    </table>
</div>

<!-- MODAL: MANAGE KEYS -->
<div id="modal-keys" class="modal hidden">
    <div class="modal-content">
        <h3 id="modal-keys-title">ZarzƒÖdzaj kluczami</h3>
        <input type="hidden" id="key-prod-id">
        <div class="stat-card" style="margin-bottom: 20px;">
            <div class="label">Aktualny stan magazynowy</div>
            <div id="key-stock-info" class="value">≈Åadowanie...</div>
        </div>
        <div class="form-group">
            <label>Dodaj nowe klucze (jeden w linii)</label>
            <textarea id="keys-input" style="width: 100%; height: 150px; padding: 10px; border: 1px solid #374151; border-radius: 6px; background: #0f0f23; color: #e0e0e0; font-family: monospace;" placeholder="ABCD-1234-EFGH-5678&#10;IJKL-9012-MNOP-3456"></textarea>
        </div>
        <div style="display:flex; gap:12px; margin-top:24px">
            <button class="btn btn-secondary" style="flex:1" onclick="closeKeysModal()">Zamknij</button>
            <button class="btn btn-primary" style="flex:1" onclick="saveKeys()">Dodaj klucze</button>
        </div>
    </div>
</div>

<!-- MODAL: PRODUCT FORM -->
<div id="modal-product" class="modal hidden">
    <div class="modal-content">
        <h3 id="modal-product-title">Dodaj produkt</h3>
        <input type="hidden" id="prod-id">
        <div class="form-group">
            <label>Nazwa gry</label>
            <input type="text" id="prod-name" placeholder="np. Cyberpunk 2077">
        </div>
        <div class="form-group">
            <label>Opis</label>
            <input type="text" id="prod-desc" placeholder="Kr√≥tki opis gry...">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Cena (grosze)</label>
                <input type="number" id="prod-price" placeholder="4900 (= 49.00 PLN)">
            </div>
            <div class="form-group">
                <label>Waluta</label>
                <input type="text" id="prod-currency" value="PLN">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Kategoria</label>
                <input type="text" id="prod-category" placeholder="np. RPG">
            </div>
            <div class="form-group">
                <label>Platforma</label>
                <input type="text" id="prod-platform" placeholder="np. Steam">
            </div>
        </div>
        <div class="form-group">
            <label style="display:flex; align-items:center; gap:8px">
                <input type="checkbox" id="prod-active" checked style="width:auto"> Aktywny (widoczny w sklepie)
            </label>
        </div>
        <div style="display:flex; gap:12px; margin-top:24px">
            <button class="btn btn-secondary" style="flex:1" onclick="closeProductModal()">Anuluj</button>
            <button class="btn btn-primary" style="flex:1" onclick="saveProduct()">Zapisz</button>
        </div>
    </div>
</div>

<script>
const API_BASE = window.location.hostname === 'localhost' 
    ? 'http://localhost:8100' 
    : `${window.location.protocol}//${window.location.hostname}:8100`;
const API = API_BASE + '/api/v1';

let token = localStorage.getItem('token');
let userEmail = localStorage.getItem('userEmail');
let userRole = localStorage.getItem('userRole');
let cartCount = 0;
let productCache = {};

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ
function $(id) { return document.getElementById(id); }
function hideAll() { 
    ['page-login','page-register','page-products','page-cart','page-orders','page-admin'].forEach(id => $(id).classList.add('hidden')); 
}
function showEl(id) { $(id).classList.remove('hidden'); }
function hideEl(id) { $(id).classList.add('hidden'); }
function formatPrice(cents) { return (cents / 100).toFixed(2) + ' PLN'; }

async function api(path, opts = {}) {
    const headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
    if (token) headers['Authorization'] = `Bearer ${token}`;
    const res = await fetch(`${API}${path}`, { ...opts, headers });
    if (!res.ok) {
        const err = await res.json().catch(() => ({ detail: res.statusText }));
        throw new Error(err.detail || err.message || JSON.stringify(err));
    }
    if (res.status === 204) return null;
    return res.json();
}

// ‚îÄ‚îÄ‚îÄ AUTH STATE ‚îÄ‚îÄ‚îÄ
function updateNav() {
    if (token) {
        hideEl('nav-login-btn');
        showEl('nav-logout-btn');
        showEl('nav-cart-btn');
        showEl('nav-orders-btn');
        if (userRole === 'admin') showEl('nav-admin-btn');
        else hideEl('nav-admin-btn');
        showEl('nav-user');
        $('nav-user').textContent = userEmail || '';
    } else {
        showEl('nav-login-btn');
        hideEl('nav-logout-btn');
        hideEl('nav-cart-btn');
        hideEl('nav-orders-btn');
        hideEl('nav-admin-btn');
        hideEl('nav-user');
    }
}

function logout() {
    token = null;
    userEmail = null;
    userRole = null;
    localStorage.removeItem('token');
    localStorage.removeItem('userEmail');
    localStorage.removeItem('userRole');
    updateNav();
    showProducts();
}

// ‚îÄ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ‚îÄ
function showLogin() { hideAll(); showEl('page-login'); hideEl('login-error'); }
function showRegister() { hideAll(); showEl('page-register'); hideEl('reg-error'); hideEl('reg-success'); }
function showProducts() { hideAll(); showEl('page-products'); loadProducts(); }
function showCart() { if (!token) return showLogin(); hideAll(); showEl('page-cart'); loadCart(); }
function showOrders() { if (!token) return showLogin(); hideAll(); showEl('page-orders'); loadOrders(); }
function showAdmin() { if (userRole !== 'admin') return showProducts(); hideAll(); showEl('page-admin'); loadAdminData(); }

// ‚îÄ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ
async function doLogin() {
    hideEl('login-error');
    const email = $('login-email').value.trim();
    const password = $('login-password').value;
    if (!email || !password) { $('login-error').textContent = 'Wype≈Çnij wszystkie pola'; showEl('login-error'); return; }
    try {
        const data = await api('/login', { method: 'POST', body: JSON.stringify({ email, password }) });
        token = data.access_token;
        userEmail = email;
        
        // Decode JWT to get role
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            userRole = payload.role || payload['X-User-Role'] || 'user';
        } catch (e) {
            userRole = 'user';
        }

        localStorage.setItem('token', token);
        localStorage.setItem('userEmail', email);
        localStorage.setItem('userRole', userRole);

        updateNav();
        showProducts();
        loadCartCount();
    } catch (e) {
        $('login-error').textContent = e.message;
        showEl('login-error');
    }
}

// ‚îÄ‚îÄ‚îÄ REGISTER ‚îÄ‚îÄ‚îÄ
async function doRegister() {
    hideEl('reg-error'); hideEl('reg-success');
    const email = $('reg-email').value.trim();
    const password = $('reg-password').value;
    if (!email || !password) { $('reg-error').textContent = 'Wype≈Çnij wszystkie pola'; showEl('reg-error'); return; }
    try {
        await api('/register', { method: 'POST', body: JSON.stringify({ email, password }) });
        $('reg-success').textContent = 'Konto utworzone! Mo≈ºesz siƒô zalogowaƒá.';
        showEl('reg-success');
    } catch (e) {
        $('reg-error').textContent = e.message;
        showEl('reg-error');
    }
}

// ‚îÄ‚îÄ‚îÄ PRODUCTS ‚îÄ‚îÄ‚îÄ
async function loadProducts() {
    showEl('products-loading');
    const search = $('filter-search').value.trim();
    const platform = $('filter-platform').value;
    const [sort_by, sort_dir] = $('filter-sort').value.split(':');
    let qs = `?sort_by=${sort_by}&sort_dir=${sort_dir}&is_active=true`;
    if (search) qs += `&search=${encodeURIComponent(search)}`;
    if (platform) qs += `&platform=${encodeURIComponent(platform)}`;
    try {
        const products = await api(`/products${qs}`);
        productCache = {};
        products.forEach(p => productCache[p.id] = p);
        $('products-grid').innerHTML = products.length === 0 
            ? '<div class="loading-overlay">Brak produkt√≥w</div>'
            : products.map(p => `
                <div class="product-card">
                    <h3>${esc(p.name)}</h3>
                    <div class="platform">${esc(p.platform || '‚Äî')}</div>
                    <div class="category">${esc(p.category || '')}</div>
                    <div class="price">${formatPrice(p.price_cents)}</div>
                    ${p.description ? `<p style="color:#9ca3af;font-size:0.85rem;margin-bottom:12px">${esc(p.description)}</p>` : ''}
                    ${token ? `<button class="btn btn-primary add-cart" onclick="addToCart(${p.id})">Dodaj do koszyka</button>` : ''}
                </div>
            `).join('');
    } catch (e) {
        $('products-grid').innerHTML = `<div class="error-msg">B≈ÇƒÖd: ${esc(e.message)}</div>`;
    }
    hideEl('products-loading');
}

function esc(s) { 
    if (!s) return '';
    const d = document.createElement('div'); 
    d.textContent = s; 
    return d.innerHTML; 
}

// ‚îÄ‚îÄ‚îÄ ADD TO CART ‚îÄ‚îÄ‚îÄ
async function addToCart(productId) {
    try {
        await api('/orders/cart', { method: 'POST', body: JSON.stringify({ product_id: productId, quantity: 1 }) });
        loadCartCount();
        alert('Dodano do koszyka!');
    } catch (e) {
        alert('B≈ÇƒÖd: ' + e.message);
    }
}

async function loadCartCount() {
    if (!token) return;
    try {
        const items = await api('/orders/cart');
        cartCount = items.reduce((s, i) => s + i.quantity, 0);
        if (cartCount > 0) { $('cart-badge').textContent = cartCount; showEl('cart-badge'); }
        else hideEl('cart-badge');
    } catch (e) { /* ignore */ }
}

// ‚îÄ‚îÄ‚îÄ CART PAGE ‚îÄ‚îÄ‚îÄ
async function loadCart() {
    showEl('cart-loading'); hideEl('cart-empty'); hideEl('cart-table'); hideEl('cart-summary'); hideEl('cart-actions');
    try {
        const items = await api('/orders/cart');
        if (items.length === 0) { showEl('cart-empty'); hideEl('cart-loading'); return; }

        // Fetch product details for names/prices
        const productIds = [...new Set(items.map(i => i.product_id))];
        const products = {};
        for (const pid of productIds) {
            if (productCache[pid]) { products[pid] = productCache[pid]; continue; }
            try { products[pid] = await api(`/products/${pid}`); productCache[pid] = products[pid]; }
            catch { products[pid] = { name: `Produkt #${pid}`, price_cents: 0 }; }
        }

        let total = 0;
        $('cart-body').innerHTML = items.map(item => {
            const p = products[item.product_id] || { name: `#${item.product_id}`, price_cents: 0 };
            const lineTotal = p.price_cents * item.quantity;
            total += lineTotal;
            return `<tr>
                <td>${esc(p.name)}</td>
                <td>
                    <div class="qty-control">
                        <button onclick="updateCartQty(${item.id}, ${item.quantity - 1})" ${item.quantity <= 1 ? 'disabled' : ''}>‚àí</button>
                        <span>${item.quantity}</span>
                        <button onclick="updateCartQty(${item.id}, ${item.quantity + 1})">+</button>
                    </div>
                </td>
                <td>${formatPrice(lineTotal)}</td>
                <td><button class="btn btn-danger btn-sm" onclick="removeCartItem(${item.id})">‚úï</button></td>
            </tr>`;
        }).join('');

        $('cart-total').textContent = formatPrice(total);
        showEl('cart-table'); showEl('cart-summary'); showEl('cart-actions');
    } catch (e) {
        $('cart-body').innerHTML = `<tr><td colspan="4" class="error-msg">${esc(e.message)}</td></tr>`;
        showEl('cart-table');
    }
    hideEl('cart-loading');
}

async function updateCartQty(itemId, qty) {
    if (qty < 1) return;
    try { await api(`/orders/cart/${itemId}`, { method: 'PATCH', body: JSON.stringify({ quantity: qty }) }); loadCart(); loadCartCount(); }
    catch (e) { alert('B≈ÇƒÖd: ' + e.message); }
}

async function removeCartItem(itemId) {
    try { await api(`/orders/cart/${itemId}`, { method: 'DELETE' }); loadCart(); loadCartCount(); }
    catch (e) { alert('B≈ÇƒÖd: ' + e.message); }
}

// ‚îÄ‚îÄ‚îÄ CHECKOUT ‚îÄ‚îÄ‚îÄ
async function doCheckout() {
    if (!confirm('Czy na pewno chcesz z≈Ço≈ºyƒá zam√≥wienie?')) return;
    try {
        const order = await api('/orders/checkout', { method: 'POST' });
        alert(`Zam√≥wienie #${order.id} utworzone! Przekierowujƒô do p≈Çatno≈õci...`);
        // Create payment
        try {
            const payment = await api('/payments/create', {
                method: 'POST',
                body: JSON.stringify({
                    order_id: order.id,
                    amount_cents: order.total_amount_cents,
                    currency: order.currency
                })
            });
            if (payment.checkout_url) {
                window.location.href = payment.checkout_url;
                return;
            }
        } catch (pe) {
            alert('Nie uda≈Ço siƒô utworzyƒá p≈Çatno≈õci: ' + pe.message + '\nMo≈ºesz zap≈Çaciƒá p√≥≈∫niej z poziomu zam√≥wie≈Ñ.');
        }
        showOrders();
        loadCartCount();
    } catch (e) {
        alert('B≈ÇƒÖd: ' + e.message);
    }
}

// ‚îÄ‚îÄ‚îÄ ORDERS ‚îÄ‚îÄ‚îÄ
async function verifyPendingPayments() {
    try {
        const orders = await api('/orders/my');
        const awaiting = orders.filter(o => o.status === 'awaiting_payment');
        for (const order of awaiting) {
            try {
                await api(`/payments/verify/${order.id}`, { method: 'POST' });
            } catch (e) { /* ignore */ }
        }
    } catch (e) { /* ignore */ }
}

async function loadOrders() {
    showEl('orders-loading'); hideEl('orders-empty');
    $('orders-list').innerHTML = '';
    try {
        await verifyPendingPayments();
        const orders = await api('/orders/my');
        if (orders.length === 0) { showEl('orders-empty'); hideEl('orders-loading'); return; }

        let html = '';
        for (const o of orders) {
            const statusClass = `status-${o.status}`;
            let itemsHtml = '';
            if (o.items && o.items.length > 0) {
                itemsHtml = '<table>' + o.items.map(it => 
                    `<tr><td>Produkt #${it.product_id}</td><td>x${it.quantity}</td><td>${formatPrice(it.total_price_cents)}</td></tr>`
                ).join('') + '</table>';
            }

            let actionsHtml = '';
            if (o.status === 'awaiting_payment') {
                actionsHtml += `<button class="btn btn-success btn-sm" onclick="payOrder(${o.id}, ${o.total_amount_cents}, '${o.currency}')">Zap≈Çaƒá</button> `;
                actionsHtml += `<button class="btn btn-danger btn-sm" onclick="cancelOrder(${o.id})">Anuluj</button>`;
            }
            if (o.status === 'paid') {
                actionsHtml += `<button class="btn btn-primary btn-sm" onclick="showKeys(${o.id})">Poka≈º klucze</button>`;
            }

            html += `
                <div class="order-card">
                    <div class="order-header">
                        <span class="order-id">Zam√≥wienie #${o.id}</span>
                        <span class="status-badge ${statusClass}">${o.status}</span>
                    </div>
                    <div style="color:#9ca3af;font-size:0.85rem;margin-bottom:8px">
                        ${new Date(o.created_at).toLocaleString('pl-PL')} ¬∑ ${formatPrice(o.total_amount_cents)}
                    </div>
                    <div class="order-items">${itemsHtml}</div>
                    <div id="keys-${o.id}" class="keys-list hidden"></div>
                    <div style="margin-top:12px">${actionsHtml}</div>
                </div>`;
        }
        $('orders-list').innerHTML = html;
    } catch (e) {
        $('orders-list').innerHTML = `<div class="error-msg">${esc(e.message)}</div>`;
    }
    hideEl('orders-loading');
}

async function payOrder(orderId, amountCents, currency) {
    try {
        const payment = await api('/payments/create', {
            method: 'POST',
            body: JSON.stringify({ order_id: orderId, amount_cents: amountCents, currency })
        });
        if (payment.checkout_url) {
            window.location.href = payment.checkout_url;
        }
    } catch (e) {
        alert('B≈ÇƒÖd p≈Çatno≈õci: ' + e.message);
    }
}

async function cancelOrder(orderId) {
    if (!confirm('Anulowaƒá zam√≥wienie?')) return;
    try {
        await api(`/orders/${orderId}/cancel`, { method: 'POST' });
        loadOrders();
    } catch (e) {
        alert('B≈ÇƒÖd: ' + e.message);
    }
}

async function showKeys(orderId) {
    const el = $(`keys-${orderId}`);
    if (!el.classList.contains('hidden')) { el.classList.add('hidden'); return; }
    try {
        const data = await api(`/orders/${orderId}/keys`);
        const keys = data.keys || data || [];
        if (keys.length === 0) { el.innerHTML = '<span style="color:#9ca3af">Brak kluczy</span>'; }
        else { el.innerHTML = '<strong>Twoje klucze:</strong>' + keys.map(k => `<code>${esc(k)}</code>`).join(''); }
        el.classList.remove('hidden');
    } catch (e) {
        el.innerHTML = `<span class="error-msg">${esc(e.message)}</span>`;
        el.classList.remove('hidden');
    }
}

// ‚îÄ‚îÄ‚îÄ ADMIN DASHBOARD ‚îÄ‚îÄ‚îÄ
async function loadAdminData() {
    try {
        const dailyReports = await api('/reports/daily');
        const topProducts = await api('/reports/top-products');
        const products = await api('/products?limit=1000'); // Load products for admin

        // Stats for today (last record)
        if (dailyReports.length > 0) {
            const today = dailyReports[0];
            $('stat-orders').textContent = today.total_orders;
            $('stat-paid-orders').textContent = today.total_paid_orders;
            $('stat-revenue').textContent = formatPrice(today.total_revenue_cents);
        }

        // Top products table
        $('top-products-body').innerHTML = topProducts.map(p => `
            <tr>
                <td>#${p.product_id}</td>
                <td>${p.total_sold}</td>
                <td>${formatPrice(p.total_revenue_cents)}</td>
            </tr>
        `).join('') || '<tr><td colspan="3" style="text-align:center">Brak danych</td></tr>';

        // Daily reports table
        $('daily-reports-body').innerHTML = dailyReports.map(r => `
            <tr>
                <td>${new Date(r.report_date).toLocaleDateString()}</td>
                <td>${r.total_orders}</td>
                <td>${r.total_paid_orders}</td>
                <td>${r.total_cancelled_orders}</td>
                <td>${formatPrice(r.total_revenue_cents)}</td>
            </tr>
        `).join('') || '<tr><td colspan="5" style="text-align:center">Brak danych</td></tr>';

        // Admin products management table
        const productStock = {};
        for (const p of products) {
            try {
                const inv = await api(`/inventory/${p.id}`);
                productStock[p.id] = inv.available_qty;
            } catch (e) {
                productStock[p.id] = 'N/A';
            }
        }

        $('admin-products-body').innerHTML = products.map(p => `
            <tr>
                <td>${esc(p.name)}</td>
                <td>${esc(p.platform)}</td>
                <td>${formatPrice(p.price_cents)}</td>
                <td><strong>${productStock[p.id] || 0}</strong></td>
                <td><span class="status-badge ${p.is_active ? 'status-paid' : 'status-cancelled'}">${p.is_active ? 'Aktywny' : 'Ukryty'}</span></td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="openKeysModal(${p.id}, '${esc(p.name)}')">Klucze</button>
                    <button class="btn btn-secondary btn-sm" onclick="editProduct(${p.id})">Edytuj</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">Usu≈Ñ</button>
                </td>
            </tr>
        `).join('') || '<tr><td colspan="6" style="text-align:center">Brak produkt√≥w</td></tr>';

    } catch (e) {
        alert('B≈ÇƒÖd ≈Çadowania danych administratora: ' + e.message);
    }
}

// ‚îÄ‚îÄ‚îÄ ADMIN PRODUCT ACTIONS ‚îÄ‚îÄ‚îÄ
function openProductModal() {
    $('prod-id').value = '';
    $('prod-name').value = '';
    $('prod-desc').value = '';
    $('prod-price').value = '';
    $('prod-currency').value = 'PLN';
    $('prod-category').value = '';
    $('prod-platform').value = '';
    $('prod-active').checked = true;
    $('modal-product-title').textContent = 'Dodaj produkt';
    showEl('modal-product');
}

function closeProductModal() {
    hideEl('modal-product');
}

async function editProduct(id) {
    try {
        const p = await api(`/products/${id}`);
        $('prod-id').value = p.id;
        $('prod-name').value = p.name;
        $('prod-desc').value = p.description || '';
        $('prod-price').value = p.price_cents;
        $('prod-currency').value = p.currency;
        $('prod-category').value = p.category || '';
        $('prod-platform').value = p.platform || '';
        $('prod-active').checked = p.is_active;
        $('modal-product-title').textContent = 'Edytuj produkt';
        showEl('modal-product');
    } catch (e) {
        alert('B≈ÇƒÖd pobierania danych produktu: ' + e.message);
    }
}

async function saveProduct() {
    const id = $('prod-id').value;
    const data = {
        name: $('prod-name').value,
        description: $('prod-desc').value,
        price_cents: parseInt($('prod-price').value),
        currency: $('prod-currency').value,
        category: $('prod-category').value,
        platform: $('prod-platform').value,
        is_active: $('prod-active').checked
    };

    if (!data.name || isNaN(data.price_cents)) {
        alert('Nazwa i cena sƒÖ wymagane!');
        return;
    }

    try {
        if (id) {
            await api(`/products/${id}`, { method: 'PATCH', body: JSON.stringify(data) });
        } else {
            await api('/products', { method: 'POST', body: JSON.stringify(data) });
        }
        closeProductModal();
        loadAdminData();
        loadProducts();
    } catch (e) {
        alert('B≈ÇƒÖd zapisu: ' + e.message);
    }
}

async function deleteProduct(id) {
    if (!confirm('Czy na pewno chcesz usunƒÖƒá (dezaktywowaƒá) ten produkt?')) return;
    try {
        await api(`/products/${id}`, { method: 'DELETE' });
        loadAdminData();
        loadProducts();
    } catch (e) {
        alert('B≈ÇƒÖd usuwania: ' + e.message);
    }
}

// ‚îÄ‚îÄ‚îÄ ADMIN KEY ACTIONS ‚îÄ‚îÄ‚îÄ
async function openKeysModal(productId, productName) {
    $('key-prod-id').value = productId;
    $('modal-keys-title').textContent = `Klucze: ${productName}`;
    $('key-stock-info').textContent = '≈Åadowanie...';
    $('keys-input').value = '';
    showEl('modal-keys');

    try {
        const inv = await api(`/inventory/${productId}`);
        $('key-stock-info').textContent = `${inv.available_qty} szt. (zarezerwowane: ${inv.reserved_qty})`;
    } catch (e) {
        $('key-stock-info').textContent = 'Brak danych o stanie';
    }
}

function closeKeysModal() {
    hideEl('modal-keys');
}

async function saveKeys() {
    const productId = parseInt($('key-prod-id').value);
    const keysText = $('keys-input').value.trim();
    if (!keysText) {
        alert('Wprowad≈∫ co najmniej jeden klucz!');
        return;
    }

    const keys = keysText.split('\n').map(k => k.trim()).filter(k => k.length > 0);
    
    try {
        const res = await api('/inventory/keys', {
            method: 'POST',
            body: JSON.stringify({
                product_id: productId,
                keys: keys
            })
        });
        alert(`Pomy≈õlnie dodano ${res.added_count} kluczy.`);
        closeKeysModal();
        loadAdminData();
    } catch (e) {
        alert('B≈ÇƒÖd dodawania kluczy: ' + e.message);
    }
}

async function exportReports(format) {
    try {
        const res = await fetch(`${API}/reports/export/daily?format=${format}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Export failed');
        
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `daily_reports.${format}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
    } catch (e) {
        alert('B≈ÇƒÖd eksportu: ' + e.message);
    }
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
updateNav();
if (token) loadCartCount();

const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('view') === 'orders' && token) {
    showOrders();
    // Wyczy≈õƒá parametr z URL, ≈ºeby po od≈õwie≈ºeniu nie wraca≈Ço zawsze do zam√≥wie≈Ñ
    window.history.replaceState({}, document.title, window.location.pathname);
} else {
    loadProducts();
}

// Handle Enter key in forms
$('login-password').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
$('reg-password').addEventListener('keydown', e => { if (e.key === 'Enter') doRegister(); });
</script>
</body>
</html>
